<!DOCTYPE html>
<html>
	<head><meta charset="UTF-8"/><title>Cellular Automata</title></head>
	<style>
	input {
		font-family: Courier New, Courier, Lucida Sans Typewriter, Lucida Typewriter, monospace;
		width: 50%;
		padding: 10px;
	}
	</style>
	<body>
		<div id = "list">
		</div>
		<button onclick = "next()">+</button>
		<br/>
		<canvas width="400" height = "400" style="display: None;" id = "game"></canvas><br/>
		<button onclick = "start(this)">Next</button>
		<script>
		function handleKey(e) { // check if enter is pressed
			if (e.keyCode == 13) {
				next();
			}
		}

		function next() {
			let inputs = document.getElementById("list");
			inputs.appendChild(document.createElement("input")).addEventListener('keypress', handleKey);
			inputs.appendChild(document.createElement("br"));
		}
		
		const size = 20;
		var grid = [];
		const game = document.getElementById("game");
		var ctx;
		var mode = 0;
		var nextObj;
		
		function render() {
			for (let x = 0; x < size; ++x) {
				for (let y = 0; y < size; ++y) {
					let intensity = 255 * grid[x][y];
					ctx.fillStyle = "rgba(" + intensity + "," + intensity + "," + intensity + ",255)";
					ctx.fillRect(x * size, y * size, (x + 1) * size, (y + 1) * size);
				}
			}
		}

		function transpile(str, isBoolean) {
			if (isBoolean) {
				str = str.replaceAll(/=/, "==");
				str = str.replaceAll(/ and /, " && ");
				str = str.replaceAll(/ or /, " || ");
				str = str.replaceAll(/ not /, " ! ");
				return replaceExpressions(str);
			} else if (str.test(/.+\->.+/)) {
				let parts = str.split(/->/);
				return "if(" + transpile(parts[0], true) + "){" + transpile(parts[1], false) + ";}";
			} else if (/.+=.+/.test(str)) {
				return replaceExpressions(str);
			} else {
				return "return " + replaceExpressions(str);
			}
		}

		function replaceExpressions(str) {
			str = str.replaceAll(/sin\(/, "Math.sin(");
			str = str.replaceAll(/cos\(/, "Math.cos(");
			str = str.replaceAll(/tan\(/, "Math.tan(");
			
			str = str.replaceAll(/floor\(/, "Math.floor(");
			str = str.replaceAll(/ceil\(/, "Math.ceil(");
			
			str = str.replaceAll(/^/, "**");
		}
		
		function start(bn) {
			if (mode == 1) {
				mode = 2;
				bn.remove();
				
				setInterval(function() {
					let nextGrid = [];
					
					for (let x = 0; x < size; ++x) {
						nextGrid[x] = [];
						let prev = 0;
						let current = grid[0][x];
						
						for (let y = 0; y < size; ++y) {
							let next = y == size - 1 ? 0 : grid[x][y + 1];
							nextGrid[x][y] = nextObj(prev, x == size - 1 ? 0 : grid[x + 1][y], next, x == 0 ? 0 : grid[x - 1][y], current);
							prev = current;
							current = next;
						}
					}
					
					grid = nextGrid;
					
					render();
				}, 250);
			} else {
				mode = 1;
				bn.innerHTML = "Start";
				fn = "nextObj = function(north, east, south, west, centre) {";
				
				let inputDiv = document.getElementById("list");
				let inputs = inputDiv.children;
				
				for (let i = 0; i < inputs.length; ++i) {
					fn += transpile(inputs[i].value, false) + ";";
				}
				
				fn += "}";
				console.log(fn);
				// haha yes
				// there's no server so shouldn't have xss
				eval(fn);
				
				inputDiv.style = "display: None;"
				let buttons = document.getElementsByTagName("button");

				for (let i = 0; i < buttons.length; ++i) {
					buttons[i].remove();
				}
				
				game.style = "border:1px solid #000000;";
				game.width = size * 20;
				game.height = size * 20;
				
				ctx = game.getContext("2d");
				
				for (let x = 0; x < size; ++x) {
					let row = grid[x] = [];
					
					for (let y = 0; y < size; ++y) {
						row[y] = 0;
					}
				}
				
				render();
				// Move on to initial construction
				
				game.addEventListener('mousedown', function(e) {
					if (mode == 1) {
						// Place (1, 1, 1) populations on a 20x20x20 (0, 0, 0) grid
						let pos = getCursorPos(e);
						let gx = Math.floor(pos[0]/size);
						let gy = Math.floor(pos[1]/size);
						grid[gx][gy] = grid[gx][gy] == 0 ? 1 : 0;
						render();
					} else {
						// Pause/Play
					}
				});
			}
		}
		
		function getCursorPos(evnt) {
			let rect = game.getBoundingClientRect();
			let x = evnt.clientX - rect.left;
			let y = evnt.clientY - rect.top;
			return [x, y];
		}
		</script>
	</body>
</html>